<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>地鐵 3D - 終極穩定版</title>
    <style>
        :root { --safe-bottom: env(safe-area-inset-bottom); }
        body, html { margin: 0; padding: 0; height: 100%; background: #000; overflow: hidden; font-family: -apple-system, sans-serif; }
        .app-container { position: relative; width: 100%; height: 100%; display: flex; flex-direction: column; }
        .viewport { position: relative; flex: 1; background: #000; overflow: hidden; }
        video#v { width: 100%; height: 100%; object-fit: cover; }
        
        /* 3D 投影層：修正為與影片同比例，確保不跑位 */
        #warp-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        #canvas-text { 
            position: absolute; top: 0; left: 0; width: 1800px; height: 800px; 
            transform-origin: 0 0; z-index: 2;
            clip-path: inset(0 0 0 100%);
        }

        #kuo-logo { position: absolute; bottom: 30px; right: 30px; width: 100px; opacity: 0; transition: opacity 0.5s; z-index: 99; }

        .ui-bar { 
            background: rgba(10,10,10,0.95); padding: 15px 20px; 
            display: flex; flex-direction: column; gap: 10px; border-top: 1px solid #333; 
            padding-bottom: calc(var(--safe-bottom) + 5px); z-index: 100;
        }
        .ui-hide { display: none; }
        .row { display: flex; gap: 10px; align-items: center; }
        input[type="text"] { flex: 1; background: #222; border: 1px solid #444; color: #fff; padding: 12px; border-radius: 8px; font-size: 16px; }
        .btn-share { background: #34c759; color: #fff; border: none; padding: 12px 18px; border-radius: 8px; font-weight: bold; }
        .main-btn { background: #fff; color: #000; border: none; padding: 12px; border-radius: 8px; font-weight: bold; flex: 1; }
    </style>
</head>
<body>

<div class="app-container">
    <div class="viewport" onclick="App.toggleUI()">
        <video id="v" src="Train.mov" loop muted playsinline crossorigin="anonymous"></video>
        <div id="warp-container">
            <img id="canvas-text">
        </div>
        <img id="kuo-logo" src="IMG_6604.png">
    </div>

    <div class="ui-bar" id="ui">
        <div class="row">
            <input type="text" id="userInput" placeholder="輸入文字..." value="新年快樂" oninput="App.renderText()">
        </div>
        <div class="row">
            <input type="color" id="textColor" value="#ffffff" oninput="App.renderText()">
            <input type="color" id="bgColor" value="#000000" oninput="App.renderText()">
            <button class="btn-share" onclick="App.copyShareLink()">分享</button>
            <button class="main-btn" onclick="App.toggleUI(true)">預覽</button>
        </div>
    </div>
</div>

<canvas id="text-canvas" style="display:none;"></canvas>

<script>
const App = {
    // 原始 16:9 影片中的座標百分比
    rawPts: [{x: 0.38, y: 0.33}, {x: 0.92, y: 0.24}, {x: 0.92, y: 0.76}, {x: 0.38, y: 0.61}],
    timing: { start: 2.50, end: 3.90, hide: 5.35 },

    init: function() {
        this.v = document.getElementById('v');
        this.img = document.getElementById('canvas-text');
        this.txtCvs = document.getElementById('text-canvas');
        this.ctx = this.txtCvs.getContext('2d');
        
        const params = new URLSearchParams(window.location.search);
        if(params.has('t')) document.getElementById('userInput').value = decodeURIComponent(params.get('t'));
        if(params.get('m') === 's') this.toggleUI(true);

        window.addEventListener('resize', () => this.updateWarp());
        this.v.onloadedmetadata = () => this.updateWarp();
        this.renderText();
        this.v.play();
        this.animate();
    },

    updateWarp: function() {
        const vw = this.v.videoWidth || 1920;
        const vh = this.v.videoHeight || 1080;
        const rect = this.v.getBoundingClientRect();
        
        // 計算 object-fit: cover 造成的位移與縮放
        const vRatio = vw / vh;
        const sRatio = rect.width / rect.height;
        let scale, ox = 0, oy = 0;

        if (sRatio > vRatio) {
            scale = rect.width / vw;
            oy = (rect.height - vh * scale) / 2;
        } else {
            scale = rect.height / vh;
            ox = (rect.width - vw * scale) / 2;
        }

        const p = this.rawPts.map(pt => ({
            x: pt.x * vw * scale + ox,
            y: pt.y * vh * scale + oy
        }));

        const m = this.calcMatrix(0,0, 1800,0, 1800,800, 0,800, p[0].x, p[0].y, p[1].x, p[1].y, p[2].x, p[2].y, p[3].x, p[3].y);
        this.img.style.transform = `matrix3d(${m.join(',')})`;
    },

    renderText: function() {
        this.txtCvs.width = 1800; this.txtCvs.height = 800;
        const txt = document.getElementById('userInput').value;
        const bc = document.getElementById('bgColor').value;
        
        // 背景採用 80% 透明度
        this.ctx.fillStyle = bc + 'CC'; 
        this.ctx.fillRect(0, 0, 1800, 800);

        const lines = [];
        for (let i = 0; i < txt.length; i += 6) lines.push(txt.substring(i, i+6));

        this.ctx.save();
        this.ctx.textAlign = 'right';
        this.ctx.textBaseline = 'middle';
        this.ctx.fillStyle = document.getElementById('textColor').value;

        let fontSize = lines.length === 1 ? 380 : 210;
        let scaleY = lines.length === 1 ? 1.9 : 1.4;
        let lineHeight = 260;

        this.ctx.font = `900 ${fontSize}px sans-serif`;
        const startY = 400 - ((lines.length - 1) * lineHeight) / 2;

        lines.forEach((line, i) => {
            this.ctx.save();
            this.ctx.translate(1720, startY + (i * lineHeight));
            this.ctx.scale(0.88, scaleY);
            this.ctx.fillText(line, 0, 0);
            this.ctx.restore();
        });
        this.ctx.restore();
        this.img.src = this.txtCvs.toDataURL();
    },

    animate: function() {
        const t = this.v.currentTime;
        // 同步修正：使用曲線公式讓揭露邊緣跟隨火車尾
        let prog = (t - this.timing.start) / (this.timing.end - this.timing.start);
        prog = Math.pow(Math.max(0, Math.min(1, prog)), 0.85); // 0.85 修正係數

        this.img.style.clipPath = (t < this.timing.start || t >= this.timing.hide) ? 
            'inset(0 0 0 100%)' : `inset(0 0 0 ${100 - prog*100}%)`;

        document.getElementById('kuo-logo').style.opacity = (t > 2.8) ? '1' : '0';
        requestAnimationFrame(() => this.animate());
    },

    copyShareLink: function() {
        const t = encodeURIComponent(document.getElementById('userInput').value);
        const url = `${window.location.origin}${window.location.pathname}?t=${t}&m=s`;
        navigator.clipboard.writeText(url).then(() => alert('分享連結已複製！'));
    },

    toggleUI: function(hide = false) {
        document.getElementById('ui').classList.toggle('ui-hide', hide || !document.getElementById('ui').classList.contains('ui-hide'));
    },

    calcMatrix: function(x1,y1,x2,y2,x3,y3,x4,y4,px1,py1,px2,py2,px3,py3,px4,py4) {
        const a = [[x1,y1,1,0,0,0,-px1*x1,-px1*y1],[0,0,0,x1,y1,1,-py1*x1,-py1*y1],[x2,y2,1,0,0,0,-px2*x2,-px2*y2],[0,0,0,x2,y2,1,-py2*x2,-py2*y2],[x3,y3,1,0,0,0,-px3*x3,-px3*y3],[0,0,0,x3,y3,1,-py3*x3,-py3*y3],[x4,y4,1,0,0,0,-px4*x4,-px4*y4],[0,0,0,x4,y4,1,-py4*x4,-py4*y4]];
        const b = [px1,py1,px2,py2,px3,py3,px4,py4];
        for(let i=0;i<8;i++){
            let m=i; for(let j=i+1;j<8;j++) if(Math.abs(a[j][i])>Math.abs(a[m][i])) m=j;
            [a[i],a[m]]=[a[m],a[i]]; [b[i],b[m]]=[b[m],b[i]];
            for(let j=i+1;j<8;j++){ let f=a[j][i]/a[i][i]; b[j]-=f*b[i]; for(let k=i;k<8;k++) a[j][k]-=f*a[i][k]; }
        }
        const x=new Array(8);
        for(let i=7;i>=0;i--){ let s=0; for(let j=i+1;j<8;j++) s+=a[i][j]*x[j]; x[i]=(b[i]-s)/a[i][i]; }
        return [x[0],x[3],0,x[6],x[1],x[4],0,x[7],0,0,1,0,x[2],x[5],0,1];
    }
};
window.onload = () => App.init();
</script>
</body>
</html>
