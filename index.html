<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>地鐵隱藏留言 App</title>
    <style>
        :root { --accent-color: #ff0000; }
        body, html { margin: 0; padding: 0; height: 100%; background: #000; overflow: hidden; font-family: sans-serif; }

        .app-container { position: relative; width: 100vw; height: 100vh; display: flex; flex-direction: column; }

        /* 影片視窗 */
        .viewport { position: relative; flex: 1; background: #111; overflow: hidden; }
        video#train-video { width: 100%; height: 100%; object-fit: cover; }

        /* 1. 物理透視層 (Stage) */
        .perspective-stage {
            position: absolute;
            top: 25%; /* 對齊綠板高度 */
            left: 0;
            width: 100%;
            height: 35%;
            z-index: 10;
            perspective: 1200px;
            pointer-events: none;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* 2. 梯形變形容器 (Trapezoid Board) */
        /* 這裡模擬將橫條圖貼在牆上的角度 */
        .trapezoid-board {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            /* 調整這些參數來精確對齊綠板 */
            transform: rotateY(-48deg) skewY(-7.5deg) translateX(40px);
            transform-origin: center right;
            
            /* 3. 遮罩移除機制 (Mask) */
            /* 遮罩會隨火車移動從 100% (全遮) 變為 0% (全開) */
            clip-path: inset(0 0 0 100%); 
        }

        /* 文字橫條圖樣式 */
        #text-canvas-image {
            max-width: 90%;
            height: auto;
            /* 模擬噴漆質感 */
            filter: blur(0.5px) drop-shadow(4px 4px 8px rgba(0,0,0,0.6));
            opacity: 0.95;
        }

        /* App UI 介面 */
        .ui-panel {
            background: rgba(15, 15, 15, 1);
            padding: 15px 20px;
            display: flex;
            gap: 10px;
            z-index: 100;
            border-top: 1px solid #333;
        }

        input#msg-input {
            flex: 1;
            background: #222;
            border: 1px solid #444;
            color: #fff;
            padding: 12px 18px;
            border-radius: 25px;
            font-size: 16px;
            outline: none;
        }

        button#play-btn {
            background: var(--accent-color);
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 25px;
            font-weight: bold;
            cursor: pointer;
        }
    </style>
</head>
<body>

<div class="app-container">
    <div class="viewport">
        <video id="train-video" playsinline muted>
            <source src="Train.mov" type="video/quicktime">
            <source src="Train.mov" type="video/mp4">
        </video>

        <div class="perspective-stage">
            <div id="reveal-gate" class="trapezoid-board">
                <img id="text-canvas-image" alt="message-strip">
            </div>
        </div>
    </div>

    <div class="ui-panel">
        <input type="text" id="msg-input" placeholder="想說什麼？" value="白六愛媽媽">
        <button id="play-btn" onclick="AppModule.execute()">播放</button>
    </div>
</div>

<canvas id="hidden-canvas" style="display:none;"></canvas>

<script>
/**
 * 留言板物理揭曉模組
 */
const AppModule = {
    config: {
        revealStart: 3.51, // 火車尾開始露出的時間
        revealEnd: 5.0,    // 火車完全開走的時間
        textColor: '#ff0000',
        fontSize: 120
    },

    // 1. 將文字轉換成橫條圖 (Canvas to Image)
    createTextStrip: function(text) {
        const canvas = document.getElementById('hidden-canvas');
        const ctx = canvas.getContext('2d');
        
        // 根據文字長度計算畫布寬度
        ctx.font = `900 ${this.config.fontSize}px "Microsoft JhengHei", sans-serif`;
        const textMetrics = ctx.measureText(text);
        canvas.width = textMetrics.width + 100;
        canvas.height = this.config.fontSize + 60;

        // 重新繪製文字
        ctx.font = `900 ${this.config.fontSize}px "Microsoft JhengHei", sans-serif`;
        ctx.fillStyle = this.config.textColor;
        ctx.textBaseline = 'middle';
        ctx.textAlign = 'center';
        ctx.fillText(text, canvas.width / 2, canvas.height / 2);

        // 輸出成圖片
        return canvas.toDataURL('image/png');
    },

    // 2. 執行揭曉動畫
    execute: function() {
        const inputVal = document.getElementById('msg-input').value;
        const video = document.getElementById('train-video');
        const gate = document.getElementById('reveal-gate');
        const img = document.getElementById('text-canvas-image');

        // 更新圖片素材
        img.src = this.createTextStrip(inputVal);

        // 重置物理狀態
        gate.style.transition = 'none';
        gate.style.clipPath = 'inset(0 0 0 100%)';
        
        video.currentTime = 0;
        video.play();

        const sync = () => {
            const now = video.currentTime;
            
            // 3. 遮罩隨列車移動揭開
            if (now >= this.config.revealStart && now <= this.config.revealEnd) {
                const progress = (now - this.config.revealStart) / (this.config.revealEnd - this.config.revealStart);
                const revealPercent = 100 - (progress * 100);
                gate.style.clipPath = `inset(0 0 0 ${revealPercent}%)`;
            } else if (now > this.config.revealEnd) {
                gate.style.clipPath = 'inset(0 0 0 0%)';
            }

            if (!video.paused && !video.ended) {
                requestAnimationFrame(sync);
            }
        };
        requestAnimationFrame(sync);
    }
};
</script>
</body>
</html>
