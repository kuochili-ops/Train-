<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>地鐵隱藏留言 App - 定位校準版</title>
    <style>
        body, html { margin: 0; padding: 0; height: 100%; background: #000; overflow: hidden; font-family: sans-serif; }
        .app-container { position: relative; width: 100%; height: 100%; display: flex; flex-direction: column; }

        /* 影片區 */
        .viewport { position: relative; flex: 1; background: #111; overflow: hidden; }
        video#bg-video { width: 100%; height: 100%; object-fit: cover; }

        /* 留言板對位層 (這是關鍵框) */
        .board-container {
            position: absolute;
            z-index: 10;
            pointer-events: none;
            display: flex;
            align-items: center;
            justify-content: center;
            /* 預設值，之後由滑桿控制 */
            top: 25%;
            left: 0;
            width: 100%;
            height: 35%;
            perspective: 1000px;
        }

        .warp-panel {
            width: 100%;
            height: 100%;
            transform-origin: center right;
            clip-path: inset(0 0 0 100%); 
        }

        #canvas-image {
            width: 100%;
            height: 100%;
            object-fit: fill;
            filter: drop-shadow(4px 4px 10px rgba(0,0,0,0.8));
        }

        /* 調校面板 (預設展開，調完可縮小) */
        .debug-panel {
            position: absolute;
            bottom: 80px; left: 10px; right: 10px;
            background: rgba(0,0,0,0.85);
            padding: 10px; border-radius: 10px;
            color: #0f0; font-family: monospace; font-size: 10px;
            display: grid; grid-template-columns: 1fr 2fr; gap: 5px;
            z-index: 200;
        }

        /* UI 控制區 */
        .ui-bar { background: #111; padding: 15px; display: flex; gap: 10px; z-index: 100; }
        input[type="text"] { flex: 1; background: #222; border: 1px solid #444; color: #fff; padding: 10px; border-radius: 5px; }
        button { background: #4CAF50; color: white; border: none; padding: 10px 15px; border-radius: 5px; font-weight: bold; }
    </style>
</head>
<body>

<div class="app-container">
    <div class="viewport">
        <video id="bg-video" playsinline muted>
            <source src="Train.mov" type="video/quicktime">
            <source src="Train.mov" type="video/mp4">
        </video>

        <div id="board-pos" class="board-container">
            <div id="mask-gate" class="warp-panel">
                <img id="canvas-image">
            </div>
        </div>
        
        <div class="debug-panel" id="debugUI">
            <label>垂直位置 %</label><input type="range" id="p-top" min="0" max="100" value="25">
            <label>高度 %</label><input type="range" id="p-height" min="10" max="80" value="35">
            <label>透視角度</label><input type="range" id="p-rotate" min="-70" max="0" value="-48">
            <label>傾斜修正</label><input type="range" id="p-skew" min="-20" max="20" value="-8">
            <label>同步時間</label><input type="range" id="p-start" min="300" max="400" value="351">
            <div id="current-vals" style="grid-column: span 2; text-align: center;">調校中...</div>
        </div>
    </div>

    <div class="ui-bar">
        <input type="text" id="userInput" value="白六愛媽媽">
        <button onclick="App.run()">播放</button>
        <button onclick="document.getElementById('debugUI').style.display='none'" style="background:#555">隱藏調校</button>
    </div>
</div>

<canvas id="temp-canvas" style="display:none;"></canvas>

<script>
    const App = {
        video: document.getElementById('bg-video'),
        gate: document.getElementById('mask-gate'),
        img: document.getElementById('canvas-image'),
        canvas: document.getElementById('temp-canvas'),

        run: function() {
            // 讀取滑桿數值
            const top = document.getElementById('p-top').value;
            const height = document.getElementById('p-height').value;
            const rotate = document.getElementById('p-rotate').value;
            const skew = document.getElementById('p-skew').value;
            const startSec = document.getElementById('p-start').value / 100;

            // 套用位置
            const container = document.getElementById('board-pos');
            container.style.top = top + "%";
            container.style.height = height + "%";
            this.gate.style.transform = `rotateY(${rotate}deg) skewY(${skew}deg)`;
            
            // 顯示數值供以後固定
            document.getElementById('current-vals').innerText = `TOP:${top} H:${height} ROT:${rotate} SKEW:${skew} START:${startSec}`;

            // 生成圖片
            this.render(document.getElementById('userInput').value);
            
            // 播放
            this.gate.style.clipPath = 'inset(0 0 0 100%)';
            this.video.currentTime = 0;
            this.video.play();
            this.sync(startSec);
        },

        render: function(text) {
            const ctx = this.canvas.getContext('2d');
            this.canvas.width = 2000; this.canvas.height = 800;
            ctx.clearRect(0, 0, 2000, 800);
            ctx.fillStyle = '#ff0000';
            ctx.font = '900 600px sans-serif';
            ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
            ctx.fillText(text, 1000, 400);
            this.img.src = this.canvas.toDataURL();
        },

        sync: function(startTime) {
            const endTime = startTime + 1.4; // 列車通過持續時間約 1.4 秒
            const loop = () => {
                const now = this.video.currentTime;
                if (now >= startTime && now <= endTime) {
                    const p = (now - startTime) / (endTime - startTime);
                    this.gate.style.clipPath = `inset(0 0 0 ${100 - (p * 100)}%)`;
                } else if (now > endTime) {
                    this.gate.style.clipPath = 'inset(0 0 0 0%)';
                }
                if (!this.video.paused && !this.video.ended) requestAnimationFrame(loop);
            };
            requestAnimationFrame(loop);
        }
    };
</script>
</body>
</html>
