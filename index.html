<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>地鐵隱藏留言 App - 滿版透視版</title>
    <style>
        body, html { margin: 0; padding: 0; height: 100%; background: #000; font-family: "Microsoft JhengHei", sans-serif; overflow: hidden; }
        .app-container { position: relative; width: 100%; height: 100%; display: flex; flex-direction: column; }

        /* 影片層 (底層) */
        .viewport { position: relative; flex: 1; background: #111; overflow: hidden; }
        video#bg-video { width: 100%; height: 100%; object-fit: cover; }

        /* 3D 透視舞台 (中層) */
        .perspective-stage {
            position: absolute;
            /* 根據你的合成圖調整位置和大小，讓它填滿綠板區域 */
            top: 23%; 
            left: 0;
            width: 100%;
            height: 42%; 
            z-index: 10;
            perspective: 1000px; /* 透視深度 */
            pointer-events: none;
        }

        /* 滿版梯形面板 (核心) */
        .full-trapezoid {
            width: 100%;
            height: 100%;
            /* 關鍵透視參數：rotateY(深度), skewY(傾斜校正) */
            /* 這些數值是為了對齊你的紅色大字合成圖 */
            transform: rotateY(-50deg) skewY(-8deg) translateX(50px) scaleY(1.1);
            transform-origin: center right;
            /* 初始遮罩：完全遮蔽 */
            clip-path: inset(0 0 0 100%); 
        }

        /* Canvas 生成的文字圖片 */
        #canvas-image {
            width: 100%;
            height: 100%;
            object-fit: fill; /* 強制填滿梯形區域 */
            /* 噴漆質感濾鏡 */
            filter: blur(0.6px) drop-shadow(4px 4px 8px rgba(0,0,0,0.7));
            opacity: 0.95;
        }

        /* App 控制介面 (上層) */
        .ui-controls {
            background: #1a1a1a; padding: 15px; display: flex; gap: 10px; z-index: 100;
            border-top: 1px solid #333;
        }
        input { flex: 1; background: #222; border: 1px solid #444; color: #fff; padding: 12px; border-radius: 8px; font-size: 16px; outline: none; }
        button { background: #d32f2f; color: white; border: none; padding: 10px 24px; border-radius: 8px; font-weight: bold; font-size: 16px; }
    </style>
</head>
<body>

<div class="app-container">
    <div class="viewport">
        <video id="bg-video" playsinline muted>
            <source src="Train.mov" type="video/quicktime">
            <source src="Train.mov" type="video/mp4">
        </video>

        <div class="perspective-stage">
            <div id="mask-gate" class="full-trapezoid">
                <img id="canvas-image" alt="Message">
            </div>
        </div>
    </div>

    <div class="ui-controls">
        <input type="text" id="userInput" placeholder="輸入留言..." value="白六愛媽媽">
        <button onclick="App.run()">播放</button>
    </div>
</div>

<canvas id="hidden-canvas" style="display: none;"></canvas>

<script>
    const App = {
        video: document.getElementById('bg-video'),
        gate: document.getElementById('mask-gate'),
        img: document.getElementById('canvas-image'),
        input: document.getElementById('userInput'),
        canvas: document.getElementById('hidden-canvas'),
        config: { start: 3.51, end: 5.0 }, // 揭曉時間區間

        // 核心功能：用 Canvas 生成滿版文字圖
        generateImage: function(text) {
            const ctx = this.canvas.getContext('2d');
            // 設定一個高解析度的畫布尺寸
            this.canvas.width = 2048;
            this.canvas.height = 600;

            // 清空畫布
            ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);

            // 設定文字樣式 (紅色、超大、粗體)
            ctx.fillStyle = '#ff0000';
            // 自動調整字體大小以填滿寬度
            let fontSize = 550;
            do {
                ctx.font = `900 ${fontSize}px "Microsoft JhengHei", sans-serif`;
                fontSize -= 10;
            } while (ctx.measureText(text).width > this.canvas.width - 100 && fontSize > 100);
            
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            
            // 繪製文字
            ctx.fillText(text, this.canvas.width / 2, this.canvas.height / 2);
            
            // 回傳圖片資料
            return this.canvas.toDataURL('image/png');
        },

        run: function() {
            const msg = this.input.value.trim();
            if (!msg) return;

            // 1. 生成圖片並更新 img src
            this.img.src = this.generateImage(msg);
            
            // 2. 重置狀態
            this.gate.style.transition = 'none';
            this.gate.style.clipPath = 'inset(0 0 0 100%)';
            this.video.currentTime = 0;
            
            // 3. 解決手機自動播放限制
            const playPromise = this.video.play();
            if (playPromise !== undefined) {
                playPromise.catch(() => {
                    this.video.muted = true;
                    this.video.play();
                });
            }

            // 4. 開始同步揭曉動畫
            this.sync();
        },

        sync: function() {
            const update = () => {
                const now = this.video.currentTime;
                if (now >= this.config.start && now <= this.config.end) {
                    const p = (now - this.config.start) / (this.config.end - this.config.start);
                    // 遮罩邊界從 100% 縮減到 0%
                    this.gate.style.clipPath = `inset(0 0 0 ${100 - (p * 100)}%)`;
                } else if (now > this.config.end) {
                    this.gate.style.clipPath = 'inset(0 0 0 0%)';
                }

                if (!this.video.paused && !this.video.ended) {
                    requestAnimationFrame(update);
                }
            };
            requestAnimationFrame(update);
        }
    };
</script>
</body>
</html>
