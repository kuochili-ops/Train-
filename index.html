<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>地鐵 3D - iPhone 終極修正版</title>
    <style>
        :root { --safe-bottom: env(safe-area-inset-bottom); }
        body, html { margin: 0; padding: 0; height: 100%; background: #000; overflow: hidden; font-family: -apple-system, sans-serif; }
        .app-container { position: relative; width: 100%; height: 100%; display: flex; flex-direction: column; }
        .viewport { position: relative; flex: 1; background: #000; overflow: hidden; cursor: pointer; }
        video#v { width: 100%; height: 100%; object-fit: cover; }
        
        /* 改用 canvas 直接投影 */
        #offscreen { 
            position: absolute; top: 0; left: 0; width: 1800px; height: 800px; 
            transform-origin: 0 0; z-index: 5; pointer-events: none;
            clip-path: inset(0 0 0 100%);
            will-change: transform;
            -webkit-transform-style: preserve-3d;
            backface-visibility: hidden;
        }
        
        #kuo-logo { 
            position: absolute; bottom: 30px; right: 30px; width: 120px; z-index: 99; 
            opacity: 0; transition: opacity 0.8s; pointer-events: none;
        }
        .ui-bar { 
            background: rgba(15, 15, 15, 0.96); padding: 18px; display: flex; flex-direction: column; gap: 12px; border-top: 1px solid #333; 
            transition: transform 0.4s; padding-bottom: calc(var(--safe-bottom) + 10px);
            position: absolute; bottom: 0; width: 100%; z-index: 100; box-sizing: border-box; backdrop-filter: blur(15px);
        }
        .ui-hide { transform: translateY(100%); visibility: hidden; }
        .row { display: flex; gap: 12px; align-items: center; color: white; font-size: 14px; }
        input[type="text"] { flex: 1; background: #222; border: 1px solid #444; color: #fff; padding: 12px; border-radius: 8px; font-size: 16px; outline: none; }
        input[type="color"] { width: 44px; height: 44px; border: none; background: none; cursor: pointer; }
        .btn-row { display: flex; gap: 10px; }
        button { flex: 1; padding: 16px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; font-size: 15px; }
        .share-btn { background: #34c759; color: white; }
    </style>
</head>
<body>

<div class="app-container">
    <div class="viewport" id="stage" onclick="App.handleScreenClick()">
        <video id="v" src="Train.mov" loop muted playsinline crossorigin="anonymous"></video>
        <canvas id="offscreen" width="1800" height="800"></canvas>
        <img id="kuo-logo" src="IMG_6604.png">
    </div>
    
    <div class="ui-bar" id="ui">
        <div class="row">
            字：<input type="color" id="textColor" value="#ffffff" oninput="App.render()">
            底：<input type="color" id="bgColor" value="#000000" oninput="App.render()">
            <input type="text" id="userInput" placeholder="輸入內容..." value="新年快樂" oninput="App.render()">
        </div>
        <div class="btn-row">
            <button class="share-btn" onclick="App.copyLink()">複製 iPhone 穩定分享連結</button>
        </div>
    </div>
</div>

<script>
const App = {
    pts: [{x: 0.08, y: 0.35}, {x: 0.94, y: 0.22}, {x: 0.94, y: 0.78}, {x: 0.08, y: 0.58}],
    timing: { start: 2.55, end: 3.83, logo: 3.8, hide: 5.35 },
    isReadonly: false,

    init: function() {
        this.v = document.getElementById('v');
        this.cvs = document.getElementById('offscreen');
        this.logo = document.getElementById('kuo-logo');
        this.ctx = this.cvs.getContext('2d');
        this.ui = document.getElementById('ui');

        const params = new URLSearchParams(window.location.search);
        if(params.has('t')) {
            document.getElementById('userInput').value = decodeURIComponent(params.get('t'));
            document.getElementById('textColor').value = '#' + (params.get('tc') || 'ffffff');
            document.getElementById('bgColor').value = '#' + (params.get('bc') || '000000');
        }
        
        if(params.get('m') === 's') {
            this.isReadonly = true;
            if(this.ui) this.ui.remove();
        }

        this.v.onloadedmetadata = () => this.update();
        window.onresize = () => this.update();
        
        this.v.play().catch(() => {
            document.addEventListener('touchstart', () => this.v.play(), {once: true});
        });

        this.render();
        this.animate();
        // 強制 iPhone 渲染
        setTimeout(() => this.update(), 500);
    },

    render: function() {
        const txt = document.getElementById('userInput').value || "";
        const tc = document.getElementById('textColor').value;
        const bc = document.getElementById('bgColor').value;
        
        this.ctx.clearRect(0,0,1800,800);
        this.ctx.save();
        
        // 智慧分行邏輯
        let weight = 0; for(let i=0;i<txt.length;i++) weight += txt.charCodeAt(i)>255?1:0.5;
        let lines = (weight <= 6) ? [txt] : [txt.substring(0, Math.ceil(txt.length/2)), txt.substring(Math.ceil(txt.length/2))];

        this.ctx.translate(1750, 400); this.ctx.textAlign = 'right'; this.ctx.textBaseline = 'middle';
        
        if (bc !== "#000000") {
            this.ctx.fillStyle = bc + "E6";
            let maxW = 0; this.ctx.font = lines.length===1 ? '900 350px sans-serif' : '900 240px sans-serif';
            lines.forEach(l => { let w = this.ctx.measureText(l).width * 0.85; if(w > maxW) maxW = w; });
            this.ctx.beginPath();
            this.ctx.roundRect(-maxW - 50, lines.length===1 ? -250 : -350, maxW + 100, lines.length===1 ? 500 : 700, 40);
            this.ctx.fill();
        }
        
        this.ctx.fillStyle = tc;
        if (lines.length === 1) { 
            this.ctx.scale(0.85, 2.0); this.ctx.font = '900 350px sans-serif'; this.ctx.fillText(lines[0], 0, 0); 
        } else { 
            this.ctx.scale(0.85, 1.3); this.ctx.font = '900 240px sans-serif'; this.ctx.fillText(lines[0], 0, -120); this.ctx.fillText(lines[1], 0, 120); 
        }
        this.ctx.restore();
    },

    update: function() {
        const vw = this.v.videoWidth || 1920, vh = this.v.videoHeight || 1080;
        const r = document.getElementById('stage').getBoundingClientRect();
        const vr = vw/vh, sr = r.width/r.height;
        let s, ox=0, oy=0;
        if(sr > vr) { s = r.width/vw; oy = (r.height - vh*s)/2; }
        else { s = r.height/vh; ox = (r.width - vw*s)/2; }
        
        const p = this.pts.map(pt => ({ x: pt.x*vw*s + ox, y: pt.y*vh*s + oy }));
        const m = this.calc(0,0, 1800,0, 1800,800, 0,800, p[0].x, p[0].y, p[1].x, p[1].y, p[2].x, p[2].y, p[3].x, p[3].y);
        this.cvs.style.transform = `matrix3d(${m.join(',')}) translateZ(0)`; // iPhone 強制 GPU 開啟
    },

    animate: function() {
        const t = this.v.currentTime;
        this.cvs.style.display = (t >= this.timing.hide) ? 'none' : 'block';
        this.logo.style.opacity = (t >= this.timing.logo && t < 5.8) ? '1' : '0';
        const prog = Math.max(0, Math.min(1, (t - this.timing.start) / (this.timing.end - this.timing.start)));
        this.cvs.style.clipPath = (t < this.timing.start || t >= this.timing.hide) ? 'inset(0 0 0 100%)' : `inset(0 0 0 ${100 - prog*100}%)`;
        requestAnimationFrame(() => this.animate());
    },

    handleScreenClick: function() {
        if(this.isReadonly) { this.v.currentTime = 0; this.v.play(); }
        else { this.ui.classList.toggle('ui-hide'); setTimeout(() => this.update(), 450); }
    },

    copyLink: function() {
        const t = encodeURIComponent(document.getElementById('userInput').value);
        const tc = document.getElementById('textColor').value.replace('#','');
        const bc = document.getElementById('bgColor').value.replace('#','');
        const url = `${window.location.origin}${window.location.pathname}?t=${t}&tc=${tc}&bc=${bc}&m=s`;
        navigator.clipboard.writeText(url).then(() => alert('iPhone 連結已複製！請貼給朋友觀看。'));
    },

    calc: function(x1,y1,x2,y2,x3,y3,x4,y4,px1,py1,px2,py2,px3,py3,px4,py4) {
        const a = [[x1,y1,1,0,0,0,-px1*x1,-px1*y1],[0,0,0,x1,y1,1,-py1*x1,-py1*y1],[x2,y2,1,0,0,0,-px2*x2,-px2*y2],[0,0,0,x2,y2,1,-py2*x2,-py2*y2],[x3,y3,1,0,0,0,-px3*x3,-px3*y3],[0,0,0,x3,y3,1,-py3*x3,-py3*y3],[x4,y4,1,0,0,0,-px4*x4,-px4*y4],[0,0,0,x4,y4,1,-py4*x4,-py4*y4]];
        const b = [px1,py1,px2,py2,px3,py3,px4,py4];
        for(let i=0;i<8;i++){
            let m=i; for(let j=i+1;j<8;j++) if(Math.abs(a[j][i])>Math.abs(a[m][i])) m=j;
            [a[i],a[m]]=[a[m],a[i]]; [b[i],b[m]]=[b[m],b[i]];
            for(let j=i+1;j<8;j++){ let f=a[j][i]/a[i][i]; b[j]-=f*b[i]; for(let k=i;k<8;k++) a[j][k]-=f*a[i][k]; }
        }
        const x=new Array(8);
        for(let i=7;i>=0;i--){ let s=0; for(let j=i+1;j<8;j++) s+=a[i][j]*x[j]; x[i]=(b[i]-s)/a[i][i]; }
        return [x[0],x[3],0,x[6],x[1],x[4],0,x[7],0,0,1,0,x[2],x[5],0,1];
    }
};
window.onload = () => App.init();
</script>
</body>
</html>
